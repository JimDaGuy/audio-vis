<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="utf-8" />
	<meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description" content="An audio visualizer app, made by James DiGrazia for Project 1 of IGME 330">
    <meta name="author" content="James DiGrazia">

	<title>Project 1 - IGME 330</title>
	<link rel="icon" type="image/png" href="../favicon.png">

	<!--Import Google Fonts-->
	<link href="https://fonts.googleapis.com/css?family=Kumar+One+Outline" rel="stylesheet">
	<!--Import Font Awesome-->
	<script defer src="https://use.fontawesome.com/releases/v5.0.6/js/all.js"></script>

	<style>
		body {
			overflow: hidden;
			width:  100%;
  			height: 100%;
  			margin: 0px;
        	background: #eeeeee;
        	font-family: tahoma, verdana, sans serif;
      	}

      	#guiBox {
      		position: fixed;
      		background-color: gray;
      	}

      	#controls{
      		margin-left:10px;
        	margin-top:10px;
      	}

				.search-item {

				}

				#sp-login-button {
					color: green
				}

      	canvas {
        	background: black;
    		}



	</style>
	<!--Handlebars and JQuery needed for the Spotify Auth Code. It isn't used anywhere else-->
	<script src="//cdnjs.cloudflare.com/ajax/libs/handlebars.js/2.0.0-alpha.1/handlebars.min.js"></script>
	<script src="http://code.jquery.com/jquery-1.10.1.min.js"></script>
	<script>
	    //Setup IIFE
	    (function(){
	        'use strict';

	        //IIFE scope variables

	        //Audio variables
	        var NUM_SAMPLES = 256, audioElement, analyserNode,
	        SOUND_1 = 'media/New Adventure Theme.mp3', SOUND_2 = 'media/Peanuts Theme.mp3',
	        SOUND_3 = 'media/The Picard Song.mp3', SOUND_4 = 'https://p.scdn.co/mp3-preview/0533acec7e530a0d2cdd3227a193552482a177a6?cid=72e1db1a814c4881838c7f13b3a1528c';
	        //Canvas variables
	        var canvas, ctx;
	        //Effect varibles

					//Spotify Element Variables
					var spSearchButton, spSearchField;

	        function init(){
	        	//Setup canvas context variable
	          canvas = document.querySelector('canvas');
			   		ctx = canvas.getContext("2d");

			   		ctx.canvas.width  = window.innerWidth;
						ctx.canvas.height = window.innerHeight;

			    	//Set variable for audio element
			    	audioElement = document.querySelector('audio');

			    	// Initialize analyser node withh helper function
			    	analyserNode = createWebAudioContextWithAnalyserNode(audioElement);
			    	setupUI();

			    	// load and play default sound into audio element
			    	playStream( audioElement, SOUND_1);

						//Set the test button to return a preview link when clicked
						var but = document.getElementById("test-button");
            but.onclick = grabSongPreviewLink;

						//Setup song link return button
						//var slButton = document.getElementById("song-button");
						//slButton.onclick = grabSongPreviewLink("7MUNNBJKYo3cdokp06wEOB");

						//Set Closure-scoped variables for Spotify elements
						spSearchButton = document.getElementById("sp-search-button");
						spSearchButton.onclick = generateSearchResults;
						spSearchField = document.getElementById('sp-search-field');

			    	update();
	        }

	        function update() {
	            	// create a new array of 8-bit integers (0-255)
					var data = new Uint8Array(NUM_SAMPLES/2);
					analyserNode.getByteFrequencyData(data);

					//Clear previous frame
					ctx.clearRect(0,0, canvas.offsetWidth, canvas.offsetHeight);

					var barWidth = canvas.offsetWidth  / 64;
					var barSpacing = 1;
					var barHeight = 100;
					var topSpacing = 50;

					ctx.lineWidth = 8;

					//Called for each 0-255 value passed in
					for(var i = 0; i < data.length; i++) {
						ctx.fillStyle = 'rgba(0,255,0,0.6)';

						ctx.fillRect(i * (barWidth + barSpacing),topSpacing + 256-data[i],barWidth,barHeight);
						ctx.fillRect(canvas.offsetWidth - i * (barWidth + barSpacing), topSpacing + 256 - data[i] - 20, barWidth, barHeight);

				}

				// this schedules a call to the update() method in 1/60 seconds
				requestAnimationFrame(update);
	        }

	        //HELPER FUNCTIONS

	        function createWebAudioContextWithAnalyserNode(audioElement) {
			    var audioCtx, analyserNode, sourceNode;

			    // create new AudioContext
			    audioCtx = new (window.AudioContext || window.webkitAudioContext);

			    // create an analyser node
			    analyserNode = audioCtx.createAnalyser();

			    // fft stands for Fast Fourier Transform
		    	analyserNode.fftSize = NUM_SAMPLES;

			    // this is where we hook up the <audio> element to the analyserNode
			    sourceNode = audioCtx.createMediaElementSource(audioElement);
			    sourceNode.connect(analyserNode);

			    // here we connect to the destination i.e. speakers
			    analyserNode.connect(audioCtx.destination);
			    return analyserNode;
	    	}

	    	function setupUI(){

	    		document.querySelector("#trackSelect").onchange = function(e){
		    		playStream(audioElement,e.target.value);
		    	};

			    document.querySelector("#fsButton").onclick = function(){
			    	requestFullscreen(canvas);
		    	};

			    //Sliders and Checkboxes


		    }

		    function playStream( audioElement, path) {
		    	audioElement.src = path;
		    	//audioElement.play();
		    	audioElement.volume = 0.2;
		    	document.querySelector('#status').innerHTML = "Now playing: " + path;
		    }

		    function requestFullscreen( element) {
		    	if (element.requestFullscreen) {
		    	  element.requestFullscreen();
		    	} else if (element.mozRequestFullscreen) {
		    	  element.mozRequestFullscreen();
		    	} else if (element.mozRequestFullScreen) { // camel-cased 'S' was changed to 's' in spec
		    	  element.mozRequestFullScreen();
		    	} else if (element.webkitRequestFullscreen) {
		    	  element.webkitRequestFullscreen();
		    	}
	    		// .. and do nothing if the method is not supported
	    	}

	    	function getRandomColor() {
   				var red = Math.round(Math.random()*254+1);
   				var green = Math.round(Math.random()*254+1);
   				var blue=Math.round(Math.random()*254+1);
   				var color='rgb('+red+','+green+','+blue+')';
   				//	var color='rgba('+red+','+green+','+blue+',0.50)'; // 0.50 alpha
   				return color;
				}

				//SPOTIFY API CODE

				/**
         * Obtains parameters from the hash of the URL
         * @return Object
         */

        function getHashParams() {
          var hashParams = {};
          var e, r = /([^&;=]+)=?([^&;]*)/g,
              q = window.location.hash.substring(1);
          while ( e = r.exec(q)) {
             hashParams[e[1]] = decodeURIComponent(e[2]);
          }
          return hashParams;
        }

        var params = getHashParams();

        var access_token = params.access_token,
            refresh_token = params.refresh_token,
            error = params.error;

        if (error) {
          alert('There was an error during the authentication');
        }

				//My custom Spotify CODE

				var grabSongPreviewLink = function(songCode) {
					var requestLink = 'https://api.spotify.com/v1/tracks/' + songCode;
					$.ajax({
						url: requestLink,
						headers: {
							'Authorization': 'Bearer ' + access_token
						}
					}).done(function(data) {

						return data.preview_url;
					});
				}

				function songSearch(songQuery) {
					//Replace spaces with + to convert the query to the correct request format
					for(var i = 0; i < songQuery.length; i++)
					{
						if(songQuery[i] == ' ')
							songQuery[i] = '+';
					}

					var searchLink = 'https://api.spotify.com/v1/search?q=' + songQuery + "&limit=5&type=track";
					$.ajax({
						url: searchLink,
						headers: {
							'Authorization': 'Bearer ' + access_token
						},
						success: appendSearchResults
					}).success(function(data) {
 						//return data;
					});
				}

				var generateSearchResults = function(){
					console.dir("Generate Search Results");

					//delete old search results

					var searchSection = document.getElementById('sp-search-section');
					//Grab every div inside my search section, leaving my text section alone
					var searchSectionItems = searchSection.getElementsByTagName('div');
					//Remove previous search items from the search section
					for(var i = 0; i < searchSectionItems.length; i++) {
							searchSection.removeChild(searchSectionItems[i]);
							i--;
					}


					//Grab Search Query from input field
					var searchQuery = spSearchField.value;

					//Make API call with search query
					songSearch(searchQuery);
				}

				var appendSearchResults = function(results) {
					console.dir(results);
					var songs = results.tracks.items;
					//For each item returned
					for(var i = songs.length - 1; i >= 0; i--) {
						//Create a div element
						var searchItemElement = document.createElement("div");
						//Add my searchItem class to it for styling
						searchItemElement.classList.add("searchItem");

						//Create string containing song name and artists
						var currentSong = songs[i];
						var songName = currentSong.name;
						var artists = "";
						for(var j = 0; j < currentSong.artists.length; j++) {
							if(j != (currentSong.artists.length - 1))
								artists += currentSong.artists[j].name + ", ";
							else {
								artists += currentSong.artists[j].name;
							}
						}

						var searchItemText = songName + " by " + artists;
						var searchItemTextNode = document.createTextNode(searchItemText);

						searchItemElement.appendChild(searchItemTextNode);

						searchItemElement.appendAfter(spSearchField);
					}

					//Add song links
				}

	    	//Call init on window load
	     	window.addEventListener("load",init);
	    }());

			//Borrowed this function from
			// https://stackoverflow.com/questions/4793604/how-to-insert-an-element-after-another-element-in-javascript-without-using-a-lib
			Element.prototype.appendAfter = function (element) {
  			element.parentNode.insertBefore(this, element.nextSibling);
			},false;

    </script>
</head>
<body>
	<div id="guiBox">
		<div id="controls">
			<audio controls loop></audio>
			<label>Track List:
				<select id="trackSelect" >
					<option value="media/New Adventure Theme.mp3">New Adventure Theme</option>
					<option value="media/Peanuts Theme.mp3">Peanuts Theme</option>
					<option value="media/The Picard Song.mp3">The Picard Song</option>
					<option value="https://p.scdn.co/mp3-preview/0533acec7e530a0d2cdd3227a193552482a177a6?cid=72e1db1a814c4881838c7f13b3a1528c">Test</option>
				</select>
			</label>
			<button id="test-button">Test</button>

			<div id="sp-search-section">
				<input type='text' id="sp-search-field"/>
			</div>
			<div id="sp-search-button"><i class="fas fa-search"></i></div>

			<button id="song-button">Get Song</button>
			<a href="/login" id="sp-login-button"><i class="fab fa-spotify fa-2x"></i></a>
			<button id="fsButton">Go Full Screen</button><br>
			<p id="status">???</p>
		</div>
	</div>
	<canvas id="canvas" width="640" height="400"></canvas>


</body>
</html>
