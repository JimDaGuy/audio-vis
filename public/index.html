<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="utf-8" />
	<meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description" content="An audio visualizer app, made by James DiGrazia">
    <meta name="author" content="James DiGrazia">

	<title>Audio Visualizer</title>
	<link rel="icon" type="image/png" href="resources/favicon.png">

	<!--Import Google Fonts-->
	<link href="https://fonts.googleapis.com/css?family=Kumar+One+Outline" rel="stylesheet">
	<!--Import Font Awesome-->
	<script defer src="https://use.fontawesome.com/releases/v5.0.6/js/all.js"></script>

	<style>
			body {
				overflow: hidden;
				width:  100%;
  			height: 100%;
  			margin: 0px;
        background: #000000;
        font-family: tahoma, verdana, sans serif;
      }

      	#guiBox {
      		position: fixed;
      		background-color: gray;
					width: 400px;
					z-index: 5;
      	}

				audio {
					width: 90%;
					margin: 0 auto;
				}

      	#controls{
      		margin-left:10px;
        	margin-top:10px;
      	}

				#tracklist-container {
					width: 100%;
					margin-bottom: 5px;
				}

				#sp-search-bar {
					width: 100%;
					height: 25px;
					margin-top: 5px;
				}

				#sp-search-section {
					width: 60%;
					float: left;
				}

				#sp-search-field {
					width: 100%;
				}

				.search-item {
					width: 80%;
					text-overflow: ellipsis;
					background-color: orange;
					border: 3px solid purple;
				}

				#sp-search-button {
					float: left;
					margin-left: 15px;
				}

				#sp-login-button {
					color: green;
				}

				#settings {
					margin-top: 10px;
				}

				video {
					position: fixed;
					visibility: hidden;
					z-index: -50;
					background: rgba(0, 0, 0, 0);
				}

      	#canvas {
        	background: rgba(0, 0, 0, 0);
					z-index: 2;
    		}

				.add-button {
					background-color: green;
					width: 20px;
					height: 20px;
				}

				.add-button:hover {
					background-color: blue;
				}


	</style>
	<!--Handlebars and JQuery needed for the Spotify Auth Code. It isn't used anywhere else-->
	<script src="//cdnjs.cloudflare.com/ajax/libs/handlebars.js/2.0.0-alpha.1/handlebars.min.js"></script>
	<script src="https://code.jquery.com/jquery-1.10.1.min.js"></script>
	<script>
	    //Setup IIFE
	    (function(){
	        'use strict';

	        //IIFE scope variables

	        //Audio variables
	        var NUM_SAMPLES = 256, audioElement, analyserNode,
	        SOUND_1 = 'media/New Adventure Theme.mp3', SOUND_2 = 'media/Peanuts Theme.mp3',
	        SOUND_3 = 'media/The Picard Song.mp3', SOUND_4 = 'https://p.scdn.co/mp3-preview/0533acec7e530a0d2cdd3227a193552482a177a6?cid=72e1db1a814c4881838c7f13b3a1528c';
					var addedSongs = [];
					//Canvas variables
	        var canvas, ctx;
	        //Effect varibles
					var cosmicChicken = false, curves = false;

					var defaultSongs;

					//Spotify Element Variables
					var spSearchButton, spSearchField, spSearchBar, spSearchSection;

					//Video elements
					var videoElement;

	        function init(){
	        	//Setup canvas context variable
	          canvas = document.querySelector('canvas');
			   		ctx = canvas.getContext("2d");

			   		ctx.canvas.width  = window.innerWidth;
						ctx.canvas.height = window.innerHeight;

						videoElement = document.querySelector('video');

						videoElement.width = 5/6 * window.innerWidth;
						videoElement.height = 5/6 * window.innerHeight;

			    	//Set variable for audio element
			    	audioElement = document.querySelector('audio');
						/*
						Google Chrome had trouble requesting songs from the Spotify Preview links.
						After some googling I found this one-line fix
						Source: https://stackoverflow.com/questions/31308679/mediaelementaudiosource-outputs-zeros-due-to-cors-access-restrictions-local-mp3
						*/
						audioElement.crossOrigin = "anonymous";

			    	// Initialize analyser node with helper function
			    	analyserNode = createWebAudioContextWithAnalyserNode(audioElement);
			    	setupUI();

						//Add song name variables to the default songs
						defaultSongs = document.getElementsByClassName("default-song");
						defaultSongs[0].displayName = "New Adventure Theme";
						defaultSongs[1].displayName = "Peanuts Theme";
						defaultSongs[2].displayName = "The Picard Song";

			    	// load and play default sound into audio element
						var firstOption = document.getElementById("defaultOption");
						//console.dir(defaultSongs[0]);
			    	playStream( audioElement, defaultSongs[0]);

						//Set Closure-scoped variables for Spotify elements
						spSearchButton = document.getElementById("sp-search-button");
						spSearchButton.onclick = generateSearchResults;
						spSearchField = document.getElementById('sp-search-field');
						spSearchBar = document.getElementById('sp-search-bar');
						spSearchSection = document.getElementById('sp-search-section');

						update();
	        }

	   		function update() {
	       	// create a new array of 8-bit integers (0-255)
					var data = new Uint8Array(NUM_SAMPLES/2);
					analyserNode.getByteFrequencyData(data);

					//Clear previous frame
					ctx.clearRect(0,0, canvas.offsetWidth, canvas.offsetHeight);

					var barWidth = canvas.offsetWidth  / 64;
					var barSpacing = 1;
					var barHeight = 100;
					var topSpacing = 50;

					ctx.lineWidth = 8;

					if(cosmicChicken)
						drawVideo();

					//Called for each 0-255 value passed in
					for(var i = 0; i < data.length; i++) {
						ctx.fillStyle = 'rgba(0,255,0,0.6)';

						ctx.fillRect(i * (barWidth + barSpacing),topSpacing + 256-data[i],barWidth,barHeight);
						ctx.fillRect(canvas.offsetWidth - i * (barWidth + barSpacing), topSpacing + 256 - data[i] - 20, barWidth, barHeight);

						if(curves && i <= (data.length - 30)) {
							//Custom Drawing Code
							drawCurves(data[i], (data.length - 30), i, 250, "white", 0);
							drawCurves(data[i], (data.length - 30), i, 200, "purple", 0);
						}
					}

					// this schedules a call to the update() method in 1/60 seconds
					requestAnimationFrame(update);
	     	}

	        //HELPER FUNCTIONS

	    	function createWebAudioContextWithAnalyserNode(audioElement) {
			    var audioCtx, analyserNode, sourceNode;

			    // create new AudioContext
			    audioCtx = new (window.AudioContext || window.webkitAudioContext);

			    // create an analyser node
			    analyserNode = audioCtx.createAnalyser();

			    // fft stands for Fast Fourier Transform
		    	analyserNode.fftSize = NUM_SAMPLES;

			    // this is where we hook up the <audio> element to the analyserNode
			    sourceNode = audioCtx.createMediaElementSource(audioElement);

					sourceNode.connect(analyserNode);

			    // here we connect to the destination i.e. speakers
			    analyserNode.connect(audioCtx.destination);
			    return analyserNode;
	    	}

	    	function setupUI(){

	    		document.querySelector("#trackSelect").onchange = function(e){
						//console.dir(e.options[e.selectedIndex].text);
						//console.dir(e.target[e.target.selectedIndex]);
		    		playStream(audioElement, e.target);
		    	};

			    document.querySelector("#fsButton").onclick = function(){
			    	requestFullscreen(canvas);
		    	};

			    //Sliders and Checkboxes

					//Cosmic Chicken
		 			document.getElementById('cosmicChickenBox').onchange = function(e){
			 			cosmicChicken = e.target.checked;
		 			};

					//Curves
					document.getElementById('curvesBox').onchange = function(e){
			 			curves = e.target.checked;
		 			};

		    }

		    function playStream( audioElement, targ) {
		    	audioElement.src = targ.value;
		    	//audioElement.play();
		    	audioElement.volume = 0.2;

					if(targ.displayName != null)
		    		document.querySelector('#status').innerHTML = "Now playing: " + targ.displayName;
					else
						document.querySelector('#status').innerHTML = "Now playing: " + targ[targ.selectedIndex].displayName;
		    }

		    function requestFullscreen( element) {
		    	if (element.requestFullscreen) {
		    	  element.requestFullscreen();
		    	} else if (element.mozRequestFullscreen) {
		    	  element.mozRequestFullscreen();
		    	} else if (element.mozRequestFullScreen) { // camel-cased 'S' was changed to 's' in spec
		    	  element.mozRequestFullScreen();
		    	} else if (element.webkitRequestFullscreen) {
		    	  element.webkitRequestFullscreen();
		    	}
	    		// .. and do nothing if the method is not supported
	    	}

	    	function getRandomColor() {
   				var red = Math.round(Math.random()*254+1);
   				var green = Math.round(Math.random()*254+1);
   				var blue=Math.round(Math.random()*254+1);
   				var color='rgb('+red+','+green+','+blue+')';
   				//	var color='rgba('+red+','+green+','+blue+',0.50)'; // 0.50 alpha
   				return color;
				}

				//DRAWING HELPER FUNCTIONS
				function drawCurves(currData, dataLength, dataIndex, radius, stColor, degreeOffset) {
					ctx.save();

					//Variables I can make parameters for later
					var center = { x: canvas.width / 2, y: canvas.height / 2 };
					var radiusCoeff = currData / 256;
					var dcMaxRadius = radiusCoeff * radius;
					var radiansPerInterval = (2 * Math.PI) / dataLength;
				var radianOffset = degreeOffset / 180 * Math.PI;


				//Change the color if the song hits highs or the color has stayed the same for too long
				/*
				if(currData == 250 || colorCounter >= colorTime) {
					bigStrokeColor = getRandomColor();
					smallStrokeColor = getRandomColor();
					colorCounter = 0;
				}
				*/

				//Create variables for the radial value of three different angles
				if(dataIndex == 0)
					var prevRad = ((2 * Math.PI) - radiansPerInterval) - (1/16 * Math.PI) + radianOffset;
				else
					var prevRad = (radiansPerInterval * (dataIndex - 1)) - (1/16 * Math.PI) + radianOffset;

				var currRad = (radiansPerInterval * dataIndex) + radianOffset;

				//Set point for further out radian
				if(dataIndex == (dataLength - 1))
					var futureRad = 0 + (1/16 * Math.PI) + radianOffset;
				else
					var futureRad = (radiansPerInterval * (dataIndex + 1)) + (1/16 * Math.PI)  + radianOffset;

					//Find points we need
					var firstCircRadius = 1/4 * dcMaxRadius;
					var secondCircRadius = 1/2 * dcMaxRadius;
					var thirdCircRadius = 3/4 * dcMaxRadius;

					var firstCircPoint = {};
					firstCircPoint.x = center.x + firstCircRadius * Math.cos(currRad);
					firstCircPoint.y = center.y - firstCircRadius * Math.sin(currRad);

					var secondCircPoint = {};
					secondCircPoint.x = center.x + secondCircRadius * Math.cos(prevRad);
					secondCircPoint.y = center.y - secondCircRadius * Math.sin(prevRad);

					var thirdCircPoint = {};
					thirdCircPoint.x = center.x + thirdCircRadius * Math.cos(currRad);
					thirdCircPoint.y = center.y - thirdCircRadius * Math.sin(currRad);

					var fourthCircPoint = {};
					fourthCircPoint.x = center.x + dcMaxRadius * Math.cos(prevRad);
					fourthCircPoint.y = center.y - dcMaxRadius * Math.sin(prevRad);

					ctx.strokeStyle = stColor;
					//Draw quadratic curves
					ctx.beginPath();
					ctx.moveTo(center.x, center.y);
					ctx.quadraticCurveTo(secondCircPoint.x, secondCircPoint.y, thirdCircPoint.x, thirdCircPoint.y);
					ctx.stroke();
					ctx.beginPath();
					ctx.moveTo( firstCircPoint.x, firstCircPoint.y);
					ctx.quadraticCurveTo(thirdCircPoint.x, thirdCircPoint.y, fourthCircPoint.x, fourthCircPoint.y);
					ctx.stroke();

					ctx.restore();
				}

				//VIDEO ELEMENT HELPER FUNCTIONS

				function drawVideo() {
					ctx.drawImage(videoElement, 0, 0, videoElement.clientWidth, videoElement.clientHeight);
					var imageData = ctx.getImageData( 0, 0, videoElement.clientWidth, videoElement.clientHeight);

					var data = imageData.data;
					var length = data.length;
					var width = imageData.width;

					//Iterates once every 4 pixels to greatly improve performance
					for (var i = 0; i < length; i+= 4) {
	      		var green = data[i * 4 + 1];
	      		if (green > 150) {
							data[i * 4 + 3] = 0;
							data[i * 4 + 7] = 0;
							data[i * 4 + 11] = 0;
							data[i * 4 + 15] = 0;
						}

						// invert
						var red = data[i], green = data[i+1], blue = data[i+2];
						data[i] = 255 - red;  		// set red value
						data[i+1] = 255 - green;  		// set blue value
						data[i+2] = 255 - blue;		// set green value
	    		}

					ctx.putImageData(imageData, 0, 0);
				}

				//SPOTIFY API CODE

				/**
         * Obtains parameters from the hash of the URL
         * @return Object
         */

        function getHashParams() {
          var hashParams = {};
          var e, r = /([^&;=]+)=?([^&;]*)/g,
              q = window.location.hash.substring(1);
          while ( e = r.exec(q)) {
             hashParams[e[1]] = decodeURIComponent(e[2]);
          }
          return hashParams;
        }

        var params = getHashParams();

        var access_token = params.access_token,
            refresh_token = params.refresh_token,
            error = params.error;

        if (error) {
          alert('There was an error during the authentication');
        }

				//My custom Spotify CODE

				var grabSongPreviewLink = function(songCode) {
					var requestLink = 'https://api.spotify.com/v1/tracks/' + songCode;
					$.ajax({
						url: requestLink,
						headers: {
							'Authorization': 'Bearer ' + access_token
						}
					}).done(function(data) {

						return data.preview_url;
					});
				}

				function songSearch(songQuery) {
					var fixedQuery = "";
					//Replace spaces with + to convert the query to the correct request format
					for(var i = 0; i < songQuery.length; i++)
					{
						if(songQuery[i] == ' ')
							fixedQuery += '+';
						else {
							fixedQuery += songQuery[i];
						}
					}

					var searchLink = 'https://api.spotify.com/v1/search?q=' + songQuery + "&limit=5&type=track";
					$.ajax({
						url: searchLink,
						headers: {
							'Authorization': 'Bearer ' + access_token
						},
						success: appendSearchResults
					}).success(function(data) {
 						//return data;
					});
				}

				var generateSearchResults = function(){
					console.dir("Generate Search Results");

					//delete old search results

					var searchSection = document.getElementById('sp-search-section');
					//Grab every div inside my search section, leaving my text section alone
					var searchSectionItems = searchSection.getElementsByTagName('div');
					//Remove previous search items from the search section
					for(var i = 0; i < searchSectionItems.length; i++) {
							searchSection.removeChild(searchSectionItems[i]);
							i--;
					}

					//Fix search bar height
					spSearchBar.style.height = spSearchSection.offsetHeight + 10 + "px";

					//Grab Search Query from input field
					var searchQuery = spSearchField.value;

					//Make API call with search query
					if(searchQuery != "") //Don't search an empty query
						songSearch(searchQuery);
				}

				var appendSearchResults = function(results) {
					console.dir(results);
					var songs = results.tracks.items;

					//If there are no results
					if(songs.length == 0) {
						//Create a div element
						var nothingFoundDiv = document.createElement("div");
						var nothingFoundTextNode = document.createTextNode("No songs matching your query.");
						nothingFoundDiv.appendChild(nothingFoundTextNode);
						nothingFoundDiv.appendAfter(spSearchField);
					}

					//For each song returned
					for(var i = songs.length - 1; i >= 0; i--) {
						//Create a div element
						var searchItemElement = document.createElement("div");

						//Create string containing song name and artists
						var currentSong = songs[i];

						var songName = currentSong.name;
						var artists = "";
						for(var j = 0; j < currentSong.artists.length; j++) {
							if(j != (currentSong.artists.length - 1))
								artists += currentSong.artists[j].name + ", ";
							else {
								artists += currentSong.artists[j].name;
							}
						}

						//Create span element and icon element,
						//appendChild the span and icon to the searchItemElement

						//Create search item text element
						var searchItemSpan = document.createElement("span");
						var searchItemText = songName + " by " + artists;
						searchItemSpan.innerHTML = searchItemText;

						var searchItemIcon = document.createElement("div");

						//Add important classes and id
						searchItemIcon.classList.add("add-button");
						var iconId = "song" + i;
						searchItemIcon.id = iconId;

						//Add event handler for adding the searchItem
						searchItemIcon.onclick = addSongHandlerWrapper(currentSong);

						//Append elements
						searchItemElement.appendChild(searchItemSpan);
						searchItemElement.appendChild(searchItemIcon);

						//Add my searchItem class to it for styling
						searchItemElement.classList.add("search-item");

						//Add the search item to the search result area
						searchItemElement.appendAfter(spSearchField);
					}

					//Fix search bar height
					spSearchBar.style.height = spSearchSection.offsetHeight + 10 + "px";
				}

				/**
			 * Passing parameters into an event handler's function causes issues
			 * because a function with paranthesis will get called on that line.
			 * This causes the button's event handler to just return our function's
			 * return value when triggered instead of calling our function.
			 *
			 * To fix this we had to create a wrapper containing our desired parameter
			 * and set the return value of our wrapper equal to the function we
			 * would like to call
			 *
			 * This solution is borrowed from my Shape Viewer Exercise and from here
			 * /http://2cor214.blogspot.com/2010/08/passing-arguments-to-event-handler-in.html
			**/
			var addSongHandlerWrapper = function (song) {
				var eventHandler = function()
				{
					addSongToList(song);
				}
				return eventHandler;
			}

			function addSongToList(song) {

				//Add the song to our Closure variable (addedSongs)
				addedSongs[addedSongs.length] = song;
				//console.dir(addedSongs);

				//Delete all added options elements
				var songList = document.getElementById('trackSelect');

				//Removes all added songs
				for(var i = 0; i < songList.childNodes.length; i++) {
					//If the childNode has a classList and contains the 'added-song' class
					if(songList.childNodes[i].classList != null) {
						if(songList.childNodes[i].classList.contains("added-song"))
						{
							//Delete song option element and iterate backwards
							songList.removeChild(songList.childNodes[i]);
							i--;
						}
					}

				}

				//Create new <option> elements for every added song and append them
				for(var i = 0; i < addedSongs.length; i++) {
					var songOption = document.createElement("option");
					songOption.value = addedSongs[i].preview_url;
					songOption.displayName = addedSongs[i].name;
					songOption.innerHTML = addedSongs[i].name;
					songOption.classList.add("added-song");
					console.dir(songOption);
					songList.appendChild(songOption);
				}
			}

	    	//Call init on window load
	     	window.addEventListener("load",init);
	    }());

			//Borrowed this function from
			// https://stackoverflow.com/questions/4793604/how-to-insert-an-element-after-another-element-in-javascript-without-using-a-lib
			Element.prototype.appendAfter = function (element) {
  			element.parentNode.insertBefore(this, element.nextSibling);
			},false;

    </script>
</head>
<body>
	<div id="guiBox">
		<div id="controls">

			<audio controls loop></audio>

			<div id="tracklist-container">
				<label>Track List:
					<select id="trackSelect" >
						<option value="media/New Adventure Theme.mp3" class="default-song first-song" id="defaultOption">New Adventure Theme</option>
						<option value="media/Peanuts Theme.mp3" class="default-song">Peanuts Theme</option>
						<option value="media/The Picard Song.mp3" class="default-song">The Picard Song</option>
					</select>
				</label>
			</div>

			<span>Search Spotify for Songs: </span>
			<div id="sp-search-bar">
				<div id="sp-search-section">
					<input type='text' id="sp-search-field"/>
				</div>
				<div id="sp-search-button"><i class="fas fa-search"></i></div>
			</div>

			<a href="/login" id="sp-login-button"><i class="fab fa-spotify fa-2x"></i></a>
			<button id="fsButton">Go Full Screen</button><br>

			<div id="settings">
				<span>Overlay Effects</span>
				<div>
					<span>
						<label for="cosmicChickenBox">Cosmic Chicken</label>
						<input type="checkbox" id="cosmicChickenBox">
					</span>
				</div>
				<div>
					<span>
						<label for="curvesBox">Curves</label>
						<input type="checkbox" id="curvesBox">
					</span>
				</div>
			</div>

			<p id="status">???</p>
		</div>
	</div>
	<video id="video" autoplay loop muted/>
		<source src="media/chicken.mp4" type="video/mp4">
	</video>
	<canvas id="canvas" width="640" height="400"></canvas>


</body>
</html>
